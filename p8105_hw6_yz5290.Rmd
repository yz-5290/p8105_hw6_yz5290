---
title: "p8105_hw6_yz5290"
output: html_document
date: "2025-12-03"
---

```{r}
library(tidyverse)
library(broom)
library(modelr)
```
p1
```{r}
homicide=
  read_csv("data/homicide-data.csv")|>
  janitor::clean_names()|>
  mutate(city_state = str_c(city, ", ", state)) |>
  mutate(solved = as.numeric(disposition == "Closed by arrest")) |>
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", 
                           "Kansas City, MO", "Tulsa, AL")) |>
  filter(victim_race %in% c("White", "Black")) |>
  mutate(victim_age = as.numeric(victim_age)) |>
  filter(!is.na(victim_age))
```
```{r}
#Baltimore
baltimore_data = 
  homicide |>
  filter(city_state == "Baltimore, MD")
baltimore_model = 
  glm(solved ~ victim_age + victim_sex + victim_race,
      data = baltimore_data,
      family = binomial())
baltimore_results = 
  baltimore_model |>
  tidy(conf.int = TRUE) |>
  filter(term == "victim_sexMale") |>
  mutate(
    OR = exp(estimate),
    OR_CI_low = exp(conf.low),
    OR_CI_high = exp(conf.high),
    city_state = "Baltimore, MD"
  ) |>
  select(city_state, OR, OR_CI_low, OR_CI_high)

```
```{r}
baltimore_results
```
```{r}
fit_city_model = function(city_df) {
  model_fit = 
    glm(solved ~ victim_age + victim_sex + victim_race,
        data = city_df,
        family = binomial())
  model_fit |>
    tidy(conf.int = TRUE) |>
    filter(term == "victim_sexMale") |>
    mutate(
      OR = exp(estimate),
      OR_CI_low = exp(conf.low),
      OR_CI_high = exp(conf.high)
    ) |>
    select(OR, OR_CI_low, OR_CI_high)
}
city_results = 
  homicide |>
  group_by(city_state) |>
  filter(n() >= 10) |>
  nest() |>
  mutate(
    model_results = map(data, ~possibly(fit_city_model, otherwise = NULL)(.x))
  ) |>
  filter(!map_lgl(model_results, is.null)) |>
  unnest(model_results) |>
  select(-data) |>
  arrange(OR)

  
  
```
```{r}
#make plot
city_plot = 
  city_results |>
  mutate(city_state = fct_reorder(city_state, OR)) |>
  ggplot(aes(x = OR, y = city_state)) +
  geom_point(size = 2)+
  geom_vline(xintercept = 1, linetype = "dashed", 
             color = "red", alpha = 0.5) +
  geom_errorbarh(aes(xmin = OR_CI_low, xmax = OR_CI_high), 
                 height = 0.2, alpha = 0.7) +
  labs(
    title = "Odds Ratios for Solving Homicides: Male vs Female Victims",
    subtitle = "Controlling for victim age and race",
    x = "Odds Ratio (Male vs Female)",
    y = "City"
  ) +
  theme_minimal()
city_plot
```
#this graph shows that most of points is smaller than 1, which means widespread pattern of lower clearance for male victims. Overall, homicides with female victims are more likely to be solved than those with male victims,


p2
```{r}
library(p8105.datasets)
data("weather_df")
```


```{r}
weather_df=
  weather_df|>
  select(tmin, tmax, prcp)
```
```{r}
#boot

set.seed(123)
n_boot=5000

boot_results = 
  tibble(boot_id = 1:5000) |>
  mutate(
    resample = map(boot_id, ~weather_df[sample(nrow(weather_df), replace = TRUE), ]),
    model = map(resample, ~lm(tmax ~ tmin + prcp, data = .x)),
    r2 = map_dbl(model, ~glance(.x)$r.squared),
    beta_prod = map_dbl(model, ~{
      coefs = tidy(.x)
      coefs$estimate[2] * coefs$estimate[3]  # β1 * β2
    })
  ) |>
  select(boot_id, r2, beta_prod)
boot_results |>
  summarise(
    r2_mean = mean(r2),
    r2_ci_low = quantile(r2, 0.025),
    r2_ci_high = quantile(r2, 0.975),
    beta_mean = mean(beta_prod),
    beta_ci_low = quantile(beta_prod, 0.025),
    beta_ci_high = quantile(beta_prod, 0.975)
  )

```

```{r}
p1 = 
  boot_results |>
  ggplot(aes(x = r2)) +
  geom_histogram(fill = "lightblue", bins = 30) +
  labs(title = "Bootstrap Distribution of R²")
p1
p2 = 
  boot_results |>
  ggplot(aes(x = beta_prod)) +
  geom_histogram(fill = "lightgreen", bins = 30) +
  labs(title = "Bootstrap Distribution of β1β2")
p2
```

#for plot1: 
The R squared value is around 0.942 is in the range of confidence interval (0.934, 0.947). THe r squred disbution is a little bit left skewed. 



#for plot 2:
The distribution of beta coeifficient is somehow left skewed with the negative peak-0.0058, which suggest that coefficient for tmin and prcp have opposite signs. The 95% CI (-0.0082, -0.0037) suggests a fairly tight distribution
 

P3
```{r}
birthweight=
  read_csv("data/birthweight.csv")|>
  janitor::clean_names()|>
  mutate(
    babysex = factor(babysex, labels = c("male", "female")),
    frace = factor(frace, 
                  levels = c(1, 2, 3, 4, 8, 9),
                  labels = c("White", "Black", "Asian", 
                            "Puerto Rican", "Other", "Unknown")),
    malform = factor(malform, levels = c(0, 1), labels = c("absent", "present")),
    mrace = factor(mrace,
                  levels = c(1, 2, 3, 4, 8),
                  labels = c("White", "Black", "Asian", 
                            "Puerto Rican", "Other"))
  )


```

```{r}
#model1
#I want to explore socioeconomic like finial situation, mother's race and parity and behavioral determinants like smoking relate to birthweight. 


my_original_model = lm(
  bwt ~ fincome + momage + smoken + mrace + parity + ppbmi,
  data = birthweight
)

# Model summary
summary_my_model = tidy(my_original_model, conf.int = TRUE)
summary_my_model

```

```{r}
#make the residual plot
residual_plot1 = 
  birthweight |>
  add_predictions(my_original_model) |>
  add_residuals(my_original_model) |>
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.2, color = "darkblue") +
  geom_smooth(se = FALSE) +
  labs(
    title = "Residuals vs Fitted Values: Socioeconomic-Behavioral Model",
    x = "Predicted Birthweight (grams)",
    y = "Residuals (Observed - Predicted)"
  ) +
  theme_minimal()
residual_plot1
```
#residual for  Socioeconomic-Behavioral Model are not raonld scattered. points mainly cluster aounrd 2900 and 3300 predicted birth weights. upper and lower region have almost symmetric figures while lower region have more points. 

```{r}
#model1: using length at birth and gestational age as predictors (main effects only)
model1 = lm(bwt ~ blength + gaweeks, data = birthweight)
#model2:using head circumference, length, sex, and all interactions (including the three-way interaction) between these
model2 = lm(bwt ~ bhead * blength * babysex, data = birthweight)

model1
model2

```


```{r}
# Cross-validation framework
set.seed(123)
cv_df = 
  crossv_mc(birthweight, n = 100) |> 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
# Fit models in cross-validation
cv_df1 = cv_df |> 
  mutate(
    # My model
    my_fit = map(train, \(df) lm(bwt ~ fincome + momage + smoken + mrace + parity + ppbmi, 
                                 data = df)),
    # Comparison model 1
    no_inter_fit = map(train, \(df) lm(bwt ~ blength + gaweeks, data = df)),
    # Comparison model 2
    w_inter_fit = map(train, \(df) lm(bwt ~ bhead * blength * babysex, data = df))
  ) |> 
  mutate(
    rmse_my_model = map2_dbl(my_fit, test, rmse),
    rmse_no_inter = map2_dbl(no_inter_fit, test, rmse),
    rmse_w_inter = map2_dbl(w_inter_fit, test, rmse)
  )
cv_df1
  violin_plot = 
  cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) |> 
  mutate(
    model = case_when(
      model == "my_model" ~ "My Socioeconomic Model",
      model == "no_inter" ~ "Length and Gestational Age",
      model == "w_inter" ~ "Head and Length and Sex Interactions"
    ),
    model = factor(model, levels = c("Length and Gestational Age",
                                     "My Socioeconomic Model",
                                     "Head and Length and Sex Interactions"))
  ) |> 
  ggplot(aes(x = model, y = rmse, fill = model)) +
  geom_violin(alpha = 0.7) +
  geom_boxplot(width = 0.1, fill = "white", alpha = 0.8) +
  labs(
    title = "Violin Plot of Model Prediction Error Distribution",
    x = "Model",
    y = "Root Mean Square Error (RMSE, grams)"
  ) +
  theme_minimal() 
violin_plot
```














